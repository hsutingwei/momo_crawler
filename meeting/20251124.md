# 研究進度階段性報告（爆品預測模型）

## 1. 研究目標與資料來源

**研究問題**  
利用 momo 商品的「歷史銷售快照」與「評論內容」，在某一時間點之前建立特徵，  
預測該商品在時間點之後是否會出現 **爆品式的銷售成長**。

**主要資料表**

- `products`：商品基本資訊  
  - 價格、類別等靜態屬性
- `sales_snapshots`：不同行批的銷售量  
  - `product_id, capture_time, sales_count`
- `product_comments`：商品評論  
  - `score, comment_text, like_count, has_image, has_video, has_reply, capture_time`

**時間切分設計（cutoff）**

- 目前採用固定 cutoff 日期 **2025-06-25**：
  - **X 特徵**：只使用 `capture_time <= 2025-06-25` 的資料
  - **y 標籤**：根據 `2025-06-25` 之後的銷售變化判斷是否為成長／爆品

→ 模型實際是在模擬：  
> 「在 2025-06-25 這一天，如果只看到之前的評論與銷售歷史，  
>  能不能預測它之後會不會爆發？」

---

## 2. 標籤（Label）設計演進

### 2.1 Phase 1：二元成長 vs 非成長

在 product-level 聚合後，定義：

- `max_raw_delta`：cutoff 之後每個商品的最大銷售量絕對成長（本次 - 上次）
- `max_raw_ratio`：cutoff 之後的最大相對成長率（sales / prev_sales - 1）

初期 Label 設計：

1. **baseline_v1（absolute）**
   - `y = 1`：若 `max_raw_delta >= 10`
   - 否則 `y = 0`

2. **hybrid_relaxed / hybrid_strict（hybrid）**
   - 同時考慮 delta 與 ratio：
     - relaxed：`delta >= 10 且 ratio >= 0.1`
     - strict：`delta >= 10 且 ratio >= 0.3`
   - strict 會剔除「基數很大但比例不高」的樣本  
     （例如從 36,000 → 45,000，delta 很大但 ratio ≈ 0.25）

### 2.2 Phase 2：多類別成長與「爆品」定義

針對 `max_raw_delta >= 10` 的 464 筆成長樣本，  
以 `max_raw_ratio` 的分位數定義 4 個等級（Schema C）：

- Class 0：無成長 → `max_raw_delta < 10`
- Class 1（Low Tier）：`max_raw_ratio < 0.67`
- Class 2（Mid Tier）：`0.67 <= ratio < 1.0`
- **Class 3（Top Tier / 爆品）**：`max_raw_ratio >= 1.0`（銷量翻倍以上）

**爆品二元任務 (`binary_explosive`)**

- `y = 1`：Class 3（銷量翻倍的爆品）
- `y = 0`：其他（Class 0/1/2）

> 後續的模型優化與 Error Analysis，主要都聚焦在這個「爆品預測」任務上。

---

## 3. 特徵工程與模型設計

### 3.1 初始特徵（Static / Aggregated Features）

**靜態數值／聚合特徵**

- 價格：`price`
- 評價統計：`score_mean`
- 累積評論數：`comment_count_pre`
- 累積按讚數：`like_count_sum`
- 是否曾有過銷售變動：`had_any_change_pre`
- 變動次數：`num_increases_pre`

**評論結構特徵**

- 是否有圖片：`has_image_urls`
- 圖片數量：`image_urls_count`
- 是否有影片：`has_video_url`
- 是否有賣家回覆：`has_reply_content`

**文字特徵（BoW / TF-IDF vocab）**

- 以 `tfidf_scores` 表計算全資料的 TF-IDF 總分，選出 Top N token 當做 vocab
- 對每個商品，在 cutoff 前的評論中，只要出現該 token，即設定為 1（Binary BoW）

> 這一階段的模型主要是「靜態＋累積」特徵，缺乏時間與內容細節。

### 3.2 類別不平衡與 Threshold Tuning

爆品任務中，爆品比例約為 **4–5%**（N ≈ 7,197，pos ≈ 300 多筆），  
若不處理不平衡，模型傾向「全部猜 0」。

處理方式：

1. **Class Weight / scale_pos_weight**
   - `scale_pos_weight ≈ n_neg / n_pos ≈ 20`
   - 讓正類錯誤在 loss 中權重大幅提高，使模型願意預測 1

2. **Threshold Tuning**
   - 不固定在 0.5，而是在 validation 上掃描多個 threshold
   - 以 F1（或 precision/recall trade-off）挑出 best threshold

→ 引入這兩個機制後，爆品任務從「幾乎全猜 0」變成「能抓到約 1/3 的爆品」。

### 3.3 Temporal Features（時間維度特徵）

為了解決「只看累積指標」抓不到近期熱度的問題，  
加入時間相關特徵：

- `days_since_last_comment`  
  - cutoff 到最後一則評論的天數
- `comment_count_7d / 30d（初版）`  
  - 因資料 recency 偏久，多為 0，訊號有限
- 最終採用 **90 天視窗** 為主：
  - `comment_count_90d`
  - `comment_90d_ratio = comment_count_90d / (comment_count_pre + 1)`

**發現**

- 非爆品（TN）：
  - `days_since_last_comment` 中位數約 **57 天**，平均甚至接近半年
- 爆品（TP）與部分誤判（FP / FN）：
  - 多集中在 **約 40 天內**

→ **結論：最近 90 天仍有評論，是爆品出現的「必要條件」之一**。

### 3.4 Content Features（情緒與關鍵字特徵，90 天窗）

為了區分 TP vs FP，加入近 90 天評論內容相關特徵：

- **情緒／評價相關**
  - `recent_score_mean`：近 90 天的平均評分
  - `sentiment_mean_recent`：透過簡易 lexicon 或評分近似情緒的指標
- **關鍵字相關**
  - 「促銷／活動」類關鍵字比例：`promo_terms_ratio_recent`
  - 「回購／囤貨」類關鍵字比例：`repurchase_ratio_recent`
  - 其他可擴充的詞群：新品／限量等（目前先以回購為主）

> 多數實驗採用「cutoff 前 90 天」視窗是因為：  
> 資料中多數商品的最後評論距離 cutoff 約在 40 天左右，  
> 30 天視窗訊號偏稀疏，90 天較能涵蓋有效評論。

---

## 4. 爆品預測任務的模型表現演進

以下是針對 `binary_explosive` 任務（爆品 vs 非爆品）的代表性結果  
（指標取 Best Threshold 下）：

| 版本 | 特徵組合                       | Best F1 | Best Precision | Best Recall | ROC AUC |
|------|--------------------------------|--------:|---------------:|------------:|--------:|
| v1   | 靜態＋累積（無時間、內容）     | ≈ 0.11  | ≈ 6.8%         | ≈ 33.9%     | ≈ 0.68  |
| v2   | v1 + Temporal（recency 等）    | ≈ 0.16  | ≈ 10.1%        | ≈ 42.1%     | ≈ 0.73  |
| v3   | v2 + Content（情緒＋關鍵字）   | ≈ 0.19  | ≈ 16.8%        | （略降，仍在合理範圍） | *與 v2 相近* |

**解讀**

- **v1**：在只用靜態特徵時，即使有 class weight + threshold tuning，  
  模型仍只能抓到部分爆品，Precision 十分有限。
- **v2**：加入 recency 後，Recall 顯著提高，  
  表示模型開始懂得「近期仍有互動的商品」比較有機會爆發。
- **v3**：再加入情緒與關鍵字特徵後，  
  在高信心區域（best threshold）下的 Precision 明顯提升，  
  代表模型在挑選「最有可能爆品的一群」時更加精準。

---

## 5. Error Analysis 主要發現

為了理解模型在爆品任務上的錯誤型態，  
針對 `binary_explosive` 任務，將樣本分為：

- TP：真實為爆品，模型預測為爆品
- FP：真實非爆品，模型預測為爆品
- FN：真實為爆品，模型預測為非爆品
- TN：真實非爆品，模型預測為非爆品

### 5.1 Recency（活躍度）的角色

- TN 的 `days_since_last_comment`：
  - 中位數約 **57 天**，平均甚至接近半年
- TP / FP / FN：
  - 大多集中在 **約 40 天左右**

→ **最近仍有評論幾乎是爆品／被誤判品的共通條件**，  
  沒有近期互動的商品幾乎不會被預測為爆品。

### 5.2 Sentiment（近期評價）的影響

近 90 天評價平均：

- TP：評分最高（約 4.87）
- FP：略低於 TP（約 4.82）
- FN：再低一些（約 4.75）
- TN：明顯偏低（約 4.08）

→ 近期評價越高，越接近 TP；  
  **情緒特徵有效幫助剔除部分 TN**，但無法完全區分 TP vs FP。

### 5.3 回購／囤貨關鍵字的「反直覺」現象

`repurchase_ratio_recent`（近 90 天含「回購 / 囤貨」等詞的評論比例）：

- TP：約 **7.7%**
- FP：約 **10.9%**
- **FN：約 17.3%（最高）**

→ **大量出現回購／囤貨語彙的商品，反而較容易被模型預測為 0（FN）**。

推論：

- 這類商品本身可能已經是「老牌熱賣品」，
- 評論內容穩定偏向「一貫好用、持續回購」，
- 模型可能傾向視為「穩定熱賣」而不是「爆發性成長」，  
  對「回購型爆品」的敏感度較低。

---

## 6. 目前限制與後續規劃

**目前限制**

1. **Cutoff 固定為單一日期（2025-06-25）**  
   - 尚未檢查不同 cutoff 設定下模型表現的穩健性。
2. **文字特徵仍偏粗糙**  
   - 目前以關鍵字與簡易情緒 proxy 為主，尚未使用 sentence embedding 或主題模型。
3. **未區分不同類型爆品**  
   - 初步 Error Analysis 顯示，  
     「促銷／活動型爆品」與「回購／囤貨型爆品」可能具有不同動態，  
     但目前仍使用同一套模型與標準。

**後續規劃方向**

1. **Segment-based 爆品建模**
   - 依「回購比例、商品類別、價位區間」等分群，  
   - 比較各 segment 中爆品的特徵與模型表現，必要時設計子模型或不同 threshold。

2. **更精緻的文字表徵**
   - 導入句向量（sentence embedding）或主題模型，  
   - 捕捉「評論語意」（例如：分享性、討論度、行銷活動語氣）對爆品的影響。

3. **時間穩健性與實驗設計拓展**
   - 嘗試不同 cutoff 日期，檢查模型在不同時間切分下的穩定度。
   - 與簡單規則（例如單純依近期評論數排序）比較，  
     評估模型相對於簡單 heuristic 的增益。

---

## 6. 實驗設計合理性與資料限制討論

針對「為什麼選擇 2025-06-25 作為時間切分點」以及「資料不均（關鍵字數量、爬蟲頻率）」可能造成的公平性問題，  
本研究的設計邏輯與佐證如下：

### 6.1 為什麼選擇固定時間點（2025-06-25）？

**模擬真實部署場景（Simulation of Deployment）**  
模型的核心目標是回答：「如果我們站在今天（Today），能不能預測明天誰會爆發？」  
- 選擇 `2025-06-25` 是將其視為「虛擬的今天（Pseudo-Today）」。
- **嚴格的資訊隔離**：所有特徵（X）僅來自該時間點之前的歷史，所有標籤（y）僅來自該時間點之後的未來。這確保了模型不會偷看未來（Data Leakage），最能反映真實上線時的情境。

### 6.2 關鍵字數量不均的公平性問題

**疑慮**：不同關鍵字（如「衛生紙」vs「藍牙耳機」）在該時間點的商品數量不同，是否不公？  
**回應**：
- **模型目標是學習「通用爆發模式」**：我們希望模型學到的是「評論突然變多」、「近期好評率上升」這些跨品類的通用訊號，而不是記住特定品類的特性。
- **特徵標準化**：我們使用的特徵多為「比例（Ratio）」或「統計值（Mean/Count）」，而非絕對的商品屬性，這有助於減輕品類數量不均的影響。
- **佐證**：目前的 Error Analysis 顯示，模型能抓到不同品類的爆品，並未只集中在最大品類，顯示通用特徵有效。

### 6.3 銷售快照（Sales Snapshots）時間不固定的影響

**疑慮**：早期爬蟲不穩定，導致某些商品的銷售快照間隔不一，是否造成標籤或特徵不公？  
**回應**：
- **特徵端（X）的處理**：
  - 這反映了真實世界的資料限制。模型必須學會從「稀疏或不規律」的歷史中判斷。
  - 我們引入 `days_since_last_comment` 與 `recency` 特徵，正是為了讓模型能識別「資料過舊」或「近期無互動」的風險。實驗證明，Recency 是最重要的特徵之一，模型正確學會了「太久沒更新 = 不會爆發」。
- **標籤端（y）的處理**：
  - 我們定義的爆品是「觀測到的成長（Observed Growth）」。
  - 若因爬蟲漏抓導致漏掉某次成長（False Negative Label），這是資料雜訊（Label Noise）。
  - **緩解措施**：我們使用 `max_raw_delta`（一段時間內的最大成長），只要在觀察視窗內有抓到一次顯著跳升，就會被標記為爆品，對單點漏抓具有魯棒性（Robustness）。

---

## 附錄：階段性實驗產出（Artifacts）

若需檢視詳細數據與報告，請參考以下連結：

- **實驗總結報告（Summary）**：[summary.md](../Model/outputs_label_experiments/summary.md)
  - 包含所有實驗（v1, v2, v3）的詳細指標比較。
- **錯誤分析報告（Error Analysis）**：[binary_explosive_error_analysis.md](../Model/outputs_label_experiments/binary_explosive_error_analysis.md)
  - 包含 TP/FP/FN/TN 在各項特徵（含時間、情緒、關鍵字）的統計分布比較。
- **錯誤分析原始資料（CSV）**：[binary_explosive_error_analysis.csv](../Model/outputs_label_experiments/binary_explosive_error_analysis.csv)
  - 包含 7,197 筆測試樣本的逐筆預測結果與特徵值，可用於進一步篩選分析。
